var map=null,doPoll=!0,statuses={"Email Sent":{color:"#1abc9c",label:"label-success",icon:"fa-envelope",point:"ct-point-sent"},"Emails Sent":{color:"#1abc9c",label:"label-success",icon:"fa-envelope",point:"ct-point-sent"},"In progress":{label:"label-primary"},Queued:{label:"label-info"},Completed:{label:"label-success"},"Email Opened":{color:"#f9bf3b",label:"label-warning",icon:"fa-envelope-open",point:"ct-point-opened"},"Clicked Link":{color:"#F39C12",label:"label-clicked",icon:"fa-mouse-pointer",point:"ct-point-clicked"},Success:{color:"#f05b4f",label:"label-danger",icon:"fa-exclamation",point:"ct-point-clicked"},"Email Reported":{color:"#45d6ef",label:"label-info",icon:"fa-bullhorn",point:"ct-point-reported"},Error:{color:"#6c7a89",label:"label-default",icon:"fa-times",point:"ct-point-error"},"Error Sending Email":{color:"#6c7a89",label:"label-default",icon:"fa-times",point:"ct-point-error"},"Submitted Data":{color:"#f05b4f",label:"label-danger",icon:"fa-exclamation",point:"ct-point-clicked"},Unknown:{color:"#6c7a89",label:"label-default",icon:"fa-question",point:"ct-point-error"},Sending:{color:"#428bca",label:"label-primary",icon:"fa-spinner",point:"ct-point-sending"},Retrying:{color:"#6c7a89",label:"label-default",icon:"fa-clock-o",point:"ct-point-error"},Scheduled:{color:"#428bca",label:"label-primary",icon:"fa-clock-o",point:"ct-point-sending"},"Campaign Created":{label:"label-success",icon:"fa-rocket"}},statusMapping={"Email Sent":"sent","Email Opened":"opened","Clicked Link":"clicked","Submitted Data":"submitted_data","Email Reported":"reported"},progressListing=["Email Sent","Email Opened","Clicked Link","Submitted Data"],campaign={},bubbles=[];function dismiss(){$("#modal\\.flashes").empty(),$("#modal").modal("hide"),$("#resultsTable").dataTable().DataTable().clear().draw()}function deleteCampaign(){Swal.fire({title:"Are you sure?",text:"This will delete the campaign. This can't be undone!",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Delete Campaign",confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,showLoaderOnConfirm:!0,preConfirm:function(){return new Promise((function(resolve,reject){api.campaignId.delete(campaign.id).success((function(msg){resolve()})).error((function(data){reject(data.responseJSON.message)}))}))}}).then((function(result){result.value&&Swal.fire("Campaign Deleted!","This campaign has been deleted!","success"),$('button:contains("OK")').on("click",(function(){location.href="/campaigns"}))}))}function completeCampaign(){Swal.fire({title:"Are you sure?",text:"Gophish will stop processing events for this campaign",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Complete Campaign",confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,showLoaderOnConfirm:!0,preConfirm:function(){return new Promise((function(resolve,reject){api.campaignId.complete(campaign.id).success((function(msg){resolve()})).error((function(data){reject(data.responseJSON.message)}))}))}}).then((function(result){result.value&&(Swal.fire("Campaign Completed!","This campaign has been completed!","success"),$("#complete_button")[0].disabled=!0,$("#complete_button").text("Completed!"),doPoll=!1)}))}function exportAsCSV(scope){exportHTML=$("#exportButton").html();var csvScope=null,filename=campaign.name+" - "+capitalize(scope)+".csv";switch(scope){case"results":csvScope=campaign.results;break;case"events":csvScope=campaign.timeline}if(csvScope){$("#exportButton").html('<i class="fa fa-spinner fa-spin"></i>');var csvString=Papa.unparse(csvScope,{}),csvData=new Blob([csvString],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(csvData,filename);else{var csvURL=window.URL.createObjectURL(csvData),dlLink=document.createElement("a");dlLink.href=csvURL,dlLink.setAttribute("download",filename),document.body.appendChild(dlLink),dlLink.click(),document.body.removeChild(dlLink)}$("#exportButton").html(exportHTML)}}function replay(event_idx){return request=campaign.timeline[event_idx],details=JSON.parse(request.details),url=null,form=$("<form>").attr({method:"POST",target:"_blank"}),$.each(Object.keys(details.payload),(function(i,param){return"rid"==param||("__original_url"==param?(url=details.payload[param],!0):void $("<input>").attr({name:param}).val(details.payload[param]).appendTo(form))})),void Swal.fire({title:"Where do you want the credentials submitted to?",input:"text",showCancelButton:!0,inputPlaceholder:"http://example.com/login",inputValue:url||"",inputValidator:function(value){return new Promise((function(resolve,reject){value?resolve():reject("Invalid URL.")}))}}).then((function(result){result.value&&(url=result.value,submitForm())}));function submitForm(){form.attr({action:url}),form.appendTo("body").submit().remove()}}var renderDevice=function(event_details){var ua=UAParser(details.browser["user-agent"]),detailsString='<div class="timeline-device-details">',deviceIcon="laptop";ua.device.type&&("tablet"!=ua.device.type&&"mobile"!=ua.device.type||(deviceIcon=ua.device.type));var deviceVendor="";ua.device.vendor&&"microsoft"==(deviceVendor=ua.device.vendor.toLowerCase())&&(deviceVendor="windows");var deviceName="Unknown";ua.os.name&&("Mac OS"==(deviceName=ua.os.name)?deviceVendor="apple":"Windows"==deviceName&&(deviceVendor="windows"),ua.device.vendor&&ua.device.model&&(deviceName=ua.device.vendor+" "+ua.device.model)),ua.os.version&&(deviceName=deviceName+" (OS Version: "+ua.os.version+")"),deviceString='<div class="timeline-device-os"><span class="fa fa-stack"><i class="fa fa-'+escapeHtml(deviceIcon)+' fa-stack-2x"></i><i class="fa fa-vendor-icon fa-'+escapeHtml(deviceVendor)+' fa-stack-1x"></i></span> '+escapeHtml(deviceName)+"</div>",detailsString+=deviceString;var deviceBrowser="Unknown",browserIcon="info-circle",browserVersion="",browserString;return ua.browser&&ua.browser.name&&((deviceBrowser=(deviceBrowser=ua.browser.name).replace("Mobile ",""))&&"ie"==(browserIcon=deviceBrowser.toLowerCase())&&(browserIcon="internet-explorer"),browserVersion="(Version: "+ua.browser.version+")"),detailsString+='<div class="timeline-device-browser"><span class="fa fa-stack"><i class="fa fa-'+escapeHtml(browserIcon)+' fa-stack-1x"></i></span> '+deviceBrowser+" "+browserVersion+"</div>",detailsString+="</div>"};function renderTimeline(data){return record={id:data[0],first_name:data[2],last_name:data[3],email:data[4],position:data[5],status:data[6],reported:data[7],send_date:data[8]},results='<div class="timeline col-sm-12 well well-lg"><h6>Timeline for '+escapeHtml(record.first_name)+" "+escapeHtml(record.last_name)+'</h6><span class="subtitle">Email: '+escapeHtml(record.email)+"<br>Result ID: "+escapeHtml(record.id)+'</span><div class="timeline-graph col-sm-6">',$.each(campaign.timeline,(function(i,event){event.email&&event.email!=record.email||(results+='<div class="timeline-entry">    <div class="timeline-bar"></div>',results+='    <div class="timeline-icon '+statuses[event.message].label+'">    <i class="fa '+statuses[event.message].icon+'"></i></div>    <div class="timeline-message">'+escapeHtml(event.message)+'    <span class="timeline-date">'+moment.utc(event.time).local().format("MMMM Do YYYY h:mm:ss a")+"</span>",event.details&&(details=JSON.parse(event.details),"Clicked Link"!=event.message&&"Submitted Data"!=event.message||(deviceView=renderDevice(details),deviceView&&(results+=deviceView)),"Submitted Data"==event.message&&(results+='<div class="timeline-replay-button"><button onclick="replay('+i+')" class="btn btn-success">',results+='<i class="fa fa-refresh"></i> Replay Credentials</button></div>',results+='<div class="timeline-event-details"><i class="fa fa-caret-right"></i> View Details</div>'),details.payload&&(results+='<div class="timeline-event-results">',results+='    <table class="table table-condensed table-bordered table-striped">',results+="        <thead><tr><th>Parameter</th><th>Value(s)</tr></thead><tbody>",$.each(Object.keys(details.payload),(function(i,param){if("rid"==param)return!0;results+="    <tr>",results+="        <td>"+escapeHtml(param)+"</td>",results+="        <td>"+escapeHtml(details.payload[param])+"</td>",results+="    </tr>"})),results+="       </tbody></table>",results+="</div>"),details.error&&(results+='<div class="timeline-event-details"><i class="fa fa-caret-right"></i> View Details</div>',results+='<div class="timeline-event-results">',results+='<span class="label label-default">Error</span> '+details.error,results+="</div>")),results+="</div></div>")})),"Scheduled"!=record.status&&"Retrying"!=record.status||(results+='<div class="timeline-entry">    <div class="timeline-bar"></div>',results+='    <div class="timeline-icon '+statuses[record.status].label+'">    <i class="fa '+statuses[record.status].icon+'"></i></div>    <div class="timeline-message">Scheduled to send at '+record.send_date+"</span>"),results+="</div></div>",results}var renderTimelineChart=function(chartopts){return Highcharts.chart("timeline_chart",{chart:{zoomType:"x",type:"line",height:"200px"},title:{text:"Campaign Timeline"},xAxis:{type:"datetime",dateTimeLabelFormats:{second:"%l:%M:%S",minute:"%l:%M",hour:"%l:%M",day:"%b %d, %Y",week:"%b %d, %Y",month:"%b %Y"}},yAxis:{min:0,max:2,visible:!1,tickInterval:1,labels:{enabled:!1},title:{text:""}},tooltip:{formatter:function(){return Highcharts.dateFormat("%A, %b %d %l:%M:%S %P",new Date(this.x))+"<br>Event: "+this.point.message+"<br>Email: <b>"+this.point.email+"</b>"}},legend:{enabled:!1},plotOptions:{series:{marker:{enabled:!0,symbol:"circle",radius:3},cursor:"pointer"},line:{states:{hover:{lineWidth:1}}}},credits:{enabled:!1},series:[{data:chartopts.data,dashStyle:"shortdash",color:"#cccccc",lineWidth:1,turboThreshold:0}]})},renderPieChart=function(chartopts){return Highcharts.chart(chartopts.elemId,{chart:{type:"pie",events:{load:function(){var chart=this,rend=this.renderer,pie=this.series[0],left=this.plotLeft+pie.center[0],top=this.plotTop+pie.center[1];this.innerText=rend.text(chartopts.data[0].count,left,top).attr({"text-anchor":"middle","font-size":"24px","font-weight":"bold",fill:chartopts.colors[0],"font-family":"Helvetica,Arial,sans-serif"}).add()},render:function(){this.innerText.attr({text:chartopts.data[0].count})}}},title:{text:chartopts.title},plotOptions:{pie:{innerSize:"80%",dataLabels:{enabled:!1}}},credits:{enabled:!1},tooltip:{formatter:function(){return null!=this.key&&'<span style="color:'+this.color+'">‚óè</span>'+this.point.name+": <b>"+this.y+"%</b><br/>"}},series:[{data:chartopts.data,colors:chartopts.colors}]})},updateMap=function(results){map&&(bubbles=[],$.each(campaign.results,(function(i,result){if(0==result.latitude&&0==result.longitude)return!0;newIP=!0,$.each(bubbles,(function(i,bubble){if(bubble.ip==result.ip)return bubbles[i].radius+=1,newIP=!1,!1})),newIP&&bubbles.push({latitude:result.latitude,longitude:result.longitude,name:result.ip,fillKey:"point",radius:2})})),map.bubbles(bubbles))},setRefresh;function createStatusLabel(status,send_date){var label=statuses[status].label||"label-default",statusColumn='<span class="label '+label+'">'+status+"</span>",sendDateMessage;"Scheduled"!=status&&"Retrying"!=status||(statusColumn='<span class="label '+label+'" data-toggle="tooltip" data-placement="top" data-html="true" title="'+("Scheduled to send at "+send_date)+'">'+status+"</span>");return statusColumn}function poll(){api.campaignId.results(campaign.id).success((function(c){campaign=c;var timeline_series_data=[];$.each(campaign.timeline,(function(i,event){var event_date=moment.utc(event.time).local();timeline_series_data.push({email:event.email,x:event_date.valueOf(),y:1})}));var timeline_series_data=[],timeline_chart;$.each(campaign.timeline,(function(i,event){var event_date=moment.utc(event.time).local();timeline_series_data.push({email:event.email,message:event.message,x:event_date.valueOf(),y:1,marker:{fillColor:statuses[event.message].color}})})),$("#timeline_chart").highcharts().series[0].update({data:timeline_series_data});var email_series_data={};Object.keys(statusMapping).forEach((function(k){email_series_data[k]=0})),$.each(campaign.results,(function(i,result){email_series_data[result.status]++,result.reported&&email_series_data["Email Reported"]++;for(var step=progressListing.indexOf(result.status),i=0;i<step;i++)email_series_data[progressListing[i]]++})),$.each(email_series_data,(function(status,count){var email_data=[],chart;if(!(status in statusMapping))return!0;email_data.push({name:status,y:Math.floor(count/campaign.results.length*100),count:count}),email_data.push({name:"",y:100-Math.floor(count/campaign.results.length*100)}),$("#"+statusMapping[status]+"_chart").highcharts().series[0].update({data:email_data})})),resultsTable=$("#resultsTable").DataTable(),resultsTable.rows().every((function(i,tableLoop,rowLoop){var row=this.row(i),rowData=row.data(),rid=rowData[0];$.each(campaign.results,(function(j,result){if(result.id==rid)return rowData[8]=moment(result.send_date).format("MMMM Do YYYY, h:mm:ss a"),rowData[7]=result.reported,rowData[6]=result.status,resultsTable.row(i).data(rowData),row.child.isShown()&&($(row.node()).find("#caret").removeClass("fa-caret-right"),$(row.node()).find("#caret").addClass("fa-caret-down"),row.child(renderTimeline(row.data()))),!1}))})),resultsTable.draw(!1),updateMap(campaign.results),$('[data-toggle="tooltip"]').tooltip(),$("#refresh_message").hide(),$("#refresh_btn").show()}))}function load(){campaign.id=window.location.pathname.split("/").slice(-1)[0];var use_map=JSON.parse(localStorage.getItem("gophish.use_map"));api.campaignId.results(campaign.id).success((function(c){if(campaign=c){$("title").text(c.name+" - Gophish"),$("#loading").hide(),$("#campaignResults").show(),$("#page-title").text("Results for "+c.name),"Completed"==c.status&&($("#complete_button")[0].disabled=!0,$("#complete_button").text("Completed!"),doPoll=!1),$("#resultsTable").on("click",".timeline-event-details",(function(){payloadResults=$(this).parent().find(".timeline-event-results"),payloadResults.is(":visible")?($(this).find("i").removeClass("fa-caret-down"),$(this).find("i").addClass("fa-caret-right"),payloadResults.hide()):($(this).find("i").removeClass("fa-caret-right"),$(this).find("i").addClass("fa-caret-down"),payloadResults.show())})),resultsTable=$("#resultsTable").DataTable({destroy:!0,order:[[2,"asc"]],columnDefs:[{orderable:!1,targets:"no-sort"},{className:"details-control",targets:[1]},{visible:!1,targets:[0,8]},{render:function(data,type,row){return createStatusLabel(data,row[8])},targets:[6]},{className:"text-center",render:function(reported,type,row){return"display"==type?reported?"<i class='fa fa-check-circle text-center text-success'></i>":"<i role='button' class='fa fa-times-circle text-center text-muted' onclick='report_mail(\""+row[0]+'", "'+campaign.id+"\");'></i>":reported},targets:[7]}]}),resultsTable.clear();var email_series_data={},timeline_series_data=[];Object.keys(statusMapping).forEach((function(k){email_series_data[k]=0})),$.each(campaign.results,(function(i,result){resultsTable.row.add([result.id,'<i id="caret" class="fa fa-caret-right"></i>',escapeHtml(result.first_name)||"",escapeHtml(result.last_name)||"",escapeHtml(result.email)||"",escapeHtml(result.position)||"",result.status,result.reported,moment(result.send_date).format("MMMM Do YYYY, h:mm:ss a")]),email_series_data[result.status]++,result.reported&&email_series_data["Email Reported"]++;for(var step=progressListing.indexOf(result.status),i=0;i<step;i++)email_series_data[progressListing[i]]++})),resultsTable.draw(),$('[data-toggle="tooltip"]').tooltip(),$("#resultsTable tbody").on("click","td.details-control",(function(){var tr=$(this).closest("tr"),row=resultsTable.row(tr);row.child.isShown()?(row.child.hide(),tr.removeClass("shown"),$(this).find("i").removeClass("fa-caret-down"),$(this).find("i").addClass("fa-caret-right")):($(this).find("i").removeClass("fa-caret-right"),$(this).find("i").addClass("fa-caret-down"),row.child(renderTimeline(row.data())).show(),tr.addClass("shown"))})),$.each(campaign.timeline,(function(i,event){if("Campaign Created"==event.message)return!0;var event_date=moment.utc(event.time).local();timeline_series_data.push({email:event.email,message:event.message,x:event_date.valueOf(),y:1,marker:{fillColor:statuses[event.message].color}})})),renderTimelineChart({data:timeline_series_data}),$.each(email_series_data,(function(status,count){var email_data=[];if(!(status in statusMapping))return!0;email_data.push({name:status,y:Math.floor(count/campaign.results.length*100),count:count}),email_data.push({name:"",y:100-Math.floor(count/campaign.results.length*100)});var chart=renderPieChart({elemId:statusMapping[status]+"_chart",title:status,name:status,data:email_data,colors:[statuses[status].color,"#dddddd"]})})),use_map&&($("#resultsMapContainer").show(),map=new Datamap({element:document.getElementById("resultsMap"),responsive:!0,fills:{defaultFill:"#ffffff",point:"#283F50"},geographyConfig:{highlightFillColor:"#1abc9c",borderColor:"#283F50"},bubblesConfig:{borderColor:"#283F50"}})),updateMap(campaign.results)}})).error((function(){$("#loading").hide(),errorFlash(" Campaign not found!")}))}function refresh(){doPoll&&($("#refresh_message").show(),$("#refresh_btn").hide(),poll(),clearTimeout(setRefresh),setRefresh=setTimeout(refresh,6e4))}function report_mail(rid,cid){var r;1==confirm("Mark this mail as reported?")&&api.campaignId.get(cid).success((function(c){report_url=c.url,report_url+=report_url.endsWith("/")?"":"/",report_url+="report?rid="+rid,$.ajax({url:report_url,method:"GET",success:function(data){}}),refresh()}))}$(document).ready((function(){Highcharts.setOptions({global:{useUTC:!1}}),load(),setRefresh=setTimeout(refresh,6e4)}));